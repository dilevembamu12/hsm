Complete Directory Structure:

â””â”€â”€ ./
    â”œâ”€â”€ app
    â”‚   â”œâ”€â”€ config
    â”‚   â”‚   â”œâ”€â”€ channels.js âœ“
    â”‚   â”‚   â”œâ”€â”€ database.js âœ“
    â”‚   â”‚   â”œâ”€â”€ env.js âœ“
    â”‚   â”‚   â”œâ”€â”€ index.js âœ“
    â”‚   â”‚   â””â”€â”€ security.js âœ“
    â”‚   â”œâ”€â”€ controllers
    â”‚   â”‚   â”œâ”€â”€ authController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ dashboardController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ entityController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ entityTypeController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ formController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ formTemplateController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ kycController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ logController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ maskTemplateController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ n8nWebhookController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ permissionController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ publicFormController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ roleController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ royaltyResultController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ royaltyRulesController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ settingsController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementGroupController.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementManualTempController.js âœ“
    â”‚   â”‚   â””â”€â”€ userController.js âœ“
    â”‚   â”œâ”€â”€ db
    â”‚   â”‚   â”œâ”€â”€ migrations
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250527100222-create-roles.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250527100246-create-entity-types.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250527100301-create-entities.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250527100303-create-user.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250527111137-create-role.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250527113232-create-kyc.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250527114646-create-user-roles.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250529223317-create-fiscal-rule.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250529224011-create-mask-template.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250529224012-create-form-template.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250531112222-create-form-template-entity-type.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250602093651-create-statement-manual-temps.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250605160003-create-statement-group.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250605160004-create-statement.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250610131047-create-log.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250619124200-add-update_data-to-log-action-enum.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250619132136-add-zone-to-statements.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250619132830-change-action-type-in-logs.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250620123359-create-royalty-rules.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250620123416-create-royalty-result.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250620123417-create-royalty-calculation-logs.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250624105231-add-fieldMappings-to-mask-templates.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250624105240-add-rejected-to-royalty-result-status-enum.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250626172158-create-royalty-calculation-group.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250626173221-add-royaltyCalculationGroupId-to-RoyaltyResult.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250629173252-add_geolocation_and_contact_to_entity.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250704114141-add-rolesData-to-User.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250707115459-create-permission.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250707120100-create-role-permission.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250707120150-add-description-to-role.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250709121604-add-PhoneNumber-To-Users copy.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250709121804-add-originalData-To-statementManualTemp.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250711151726-addMonthYearToStatementManualTemps.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250712133416-add-taxeType-to-statementManualTemp.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250712141549-add-tax-period-to-statement-group.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ 20250715151731-add-RoyaltyCalculationGroupId-To-RoyaltyCalculationLogs.js âœ“
    â”‚   â”‚   â”‚   â””â”€â”€ 20250728124217-add-declareDate-to-StatementManualTemp.js âœ“
    â”‚   â”‚   â””â”€â”€ seeders
    â”‚   â”‚       â”œâ”€â”€ 20250527100822-roles-seeder.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527100823-entity-types-seeder.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527100825--entities-seeder.js copy.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527100825--entities-seeder.js.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527100825-super-admin-seeder.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527101258-kyc-seeder.js.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527105100-create-entities.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527105105-create-artf-users.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527105900-create-entities.js.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527105901-create-mask-templates.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250527105902-create-form-templates.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250707121741-permissions-seeder.js âœ“
    â”‚   â”‚       â”œâ”€â”€ 20250707121745-custom-permissions-seeder.js âœ“
    â”‚   â”‚       â””â”€â”€ 20250707124635-assign-admin-permissions-seeder.js âœ“
    â”‚   â”œâ”€â”€ locales
    â”‚   â”‚   â”œâ”€â”€ en.json âœ“
    â”‚   â”‚   â””â”€â”€ fr.json âœ“
    â”‚   â”œâ”€â”€ middlewares
    â”‚   â”‚   â”œâ”€â”€ validators
    â”‚   â”‚   â”‚   â”œâ”€â”€ authValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ dashboardValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ entityTypeValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ entityValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ formTemplateValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ formValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ kycValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ maskTemplateValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ publicFormValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ roleValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ royaltyResultValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ royaltyRuleValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ settingsValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ statementGroupValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ statementManualTempValidator.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ statementValidator.js âœ“
    â”‚   â”‚   â”‚   â””â”€â”€ userValidator.js âœ“
    â”‚   â”‚   â”œâ”€â”€ apiAuthMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ authMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ entityMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ error.js âœ“
    â”‚   â”‚   â”œâ”€â”€ formMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ formTemplateMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ handleValidationErrors.js âœ“
    â”‚   â”‚   â”œâ”€â”€ kycMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ logMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ maskTemplateMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ roleMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ royaltyResultMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ royaltyRule.js âœ“
    â”‚   â”‚   â”œâ”€â”€ settingsMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementGroupMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementManualTempMiddleware.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementMiddleware.js âœ“
    â”‚   â”‚   â””â”€â”€ userMiddleware.js âœ“
    â”‚   â”œâ”€â”€ models
    â”‚   â”‚   â”œâ”€â”€ entity.js âœ“
    â”‚   â”‚   â”œâ”€â”€ entitytype.js âœ“
    â”‚   â”‚   â”œâ”€â”€ fiscalrule.js âœ“
    â”‚   â”‚   â”œâ”€â”€ formtemplate.js âœ“
    â”‚   â”‚   â”œâ”€â”€ formtemplateentitytype.js âœ“
    â”‚   â”‚   â”œâ”€â”€ index.js âœ“
    â”‚   â”‚   â”œâ”€â”€ kyc.js âœ“
    â”‚   â”‚   â”œâ”€â”€ log.js âœ“
    â”‚   â”‚   â”œâ”€â”€ masktemplate.js âœ“
    â”‚   â”‚   â”œâ”€â”€ permission.js âœ“
    â”‚   â”‚   â”œâ”€â”€ role.js âœ“
    â”‚   â”‚   â”œâ”€â”€ rolepermission.js âœ“
    â”‚   â”‚   â”œâ”€â”€ RoyaltyCalculationGroup.js âœ“
    â”‚   â”‚   â”œâ”€â”€ royaltyCalculationLog.js âœ“
    â”‚   â”‚   â”œâ”€â”€ royaltyResult.js âœ“
    â”‚   â”‚   â”œâ”€â”€ royaltyRule.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statement.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementgroup.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementmanualtemps.js âœ“
    â”‚   â”‚   â”œâ”€â”€ user.js âœ“
    â”‚   â”‚   â””â”€â”€ userrole.js âœ“
    â”‚   â”œâ”€â”€ routes
    â”‚   â”‚   â”œâ”€â”€ api
    â”‚   â”‚   â”‚   â”œâ”€â”€ authApiRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ kycApiRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ maskTemplateApiRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ n8nWebhookRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ royaltyResultRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ royaltyRuleRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ statementApiRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ statementGroupApiRoutes.js âœ“
    â”‚   â”‚   â”‚   â””â”€â”€ statementManualTempApiRoutes.js âœ“
    â”‚   â”‚   â”œâ”€â”€ web
    â”‚   â”‚   â”‚   â”œâ”€â”€ authWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ dashboardWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ entityTypeWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ entityWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ formTemplatesWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ formWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ logWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ maskTemplateWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ publicFormWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ roleWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ royaltyResultWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ royaltyRulesRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ royaltyRulesWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ settingsWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ statementGroupWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ statementManualTempWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â”œâ”€â”€ statementWebRoutes.js âœ“
    â”‚   â”‚   â”‚   â””â”€â”€ userWebRoutes.js âœ“
    â”‚   â”‚   â””â”€â”€ index.js âœ“
    â”‚   â”œâ”€â”€ services
    â”‚   â”‚   â”œâ”€â”€ authService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ dataIntegrationService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ entityService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ formService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ iaService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ kycService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ MaskTemplateService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ notificationService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ ocrService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ royaltyCalculationService.js âœ“
    â”‚   â”‚   â”œâ”€â”€ statementService.js âœ“
    â”‚   â”‚   â””â”€â”€ userService.js âœ“
    â”‚   â”œâ”€â”€ storage
    â”‚   â”‚   â”œâ”€â”€ locations.json âœ“
    â”‚   â”‚   â””â”€â”€ roles.json âœ“
    â”‚   â”œâ”€â”€ utils
    â”‚   â”‚   â”œâ”€â”€ dataFormatter.js âœ“
    â”‚   â”‚   â”œâ”€â”€ excelProcessor copy.js âœ“
    â”‚   â”‚   â”œâ”€â”€ excelProcessor.js âœ“
    â”‚   â”‚   â”œâ”€â”€ ExcelUtil.js âœ“
    â”‚   â”‚   â”œâ”€â”€ fileUploader.js âœ“
    â”‚   â”‚   â”œâ”€â”€ hash.js âœ“
    â”‚   â”‚   â”œâ”€â”€ jwt.js âœ“
    â”‚   â”‚   â”œâ”€â”€ modelFields.js âœ“
    â”‚   â”‚   â”œâ”€â”€ n8nClient.js âœ“
    â”‚   â”‚   â””â”€â”€ validation.js âœ“
    â”‚   â””â”€â”€ views
    â”‚       â””â”€â”€ maskTemplates
    â”‚           â””â”€â”€ partials
    â”‚               â””â”€â”€ scripts
    â”‚                   â””â”€â”€ maskFieldManagement.js âœ“
    â”œâ”€â”€ n8n
    â”‚   â”œâ”€â”€ workflows
    â”‚   â”‚   â”œâ”€â”€ anomaly_detection.json âœ“
    â”‚   â”‚   â”œâ”€â”€ data_classification.json âœ“
    â”‚   â”‚   â”œâ”€â”€ declaration_notification.json âœ“
    â”‚   â”‚   â”œâ”€â”€ ocr_document_processing.json âœ“
    â”‚   â”‚   â””â”€â”€ sftp_ftp_data_ingestion.json âœ“
    â”‚   â””â”€â”€ Dockerfile âœ“
    â”œâ”€â”€ .gitignore âœ“
    â”œâ”€â”€ .gitlab-ci.yml âœ“
    â”œâ”€â”€ app.js âœ“
    â”œâ”€â”€ Dockerfile âœ“
    â”œâ”€â”€ package.json âœ“
    â””â”€â”€ README.md âœ“



--- .gitlab-ci.yml ---

stages:
  - trigger

trigger_ci_cd_pipeline:
  stage: trigger
  script:
    - |
      echo "ðŸŽ¯ DÃ©clenchement du pipeline dans le repo CI/CD... ici TOKEN = $CI_CD_TRIGGER_TOKEN"
      curl -X POST \
        -F token=$CI_CD_TRIGGER_TOKEN \
        -F ref=main \
        https://gitlab.com/api/v4/projects/70810841/trigger/pipeline
  only:
    - main

--- app.js ---

// app.js
require('dotenv').config();

// Override juste les variables de BDD si prÃ©sentes dans l'env (par GitLab CI ou Docker)
if (process.env.NODE_ENV === 'production') {
    console.log('Overriding DB variables with environment values...');
    if (process.env.OVERRIDE_BD_HOST) process.env.DB_HOST = process.env.OVERRIDE_BD_HOST;
    if (process.env.OVERRIDE_BD_USER) process.env.DB_USER = process.env.OVERRIDE_BD_USER;
    if (process.env.OVERRIDE_BD_PWD) process.env.DB_PASSWORD = process.env.OVERRIDE_BD_PWD;
    if (process.env.OVERRIDE_BD_NAME) process.env.DB_NAME = process.env.OVERRIDE_BD_NAME;

    //console.log(process.env.DB_HOST, process.env.DB_USER, process.env.DB_PWD, process.env.DB_NAME);
}
// FIN D'OVERRIDE

const ENV = require('./app/config');

//console.log(process.env.DB_HOST, process.env.DB_USER, process.env.DB_PWD, process.env.DB_NAME);


const express = require('express');
const path = require('path');


var logger = require('morgan');
const session = require('express-session');
const flash = require('connect-flash');
const methodOverride = require('method-override');

const i18n = require('i18n'); // Importation de i18n
// NOUVEAU: Importez cookie-parser et csurf
const cookieParser = require('cookie-parser');
const csurf = require('csurf');
const multer = require('multer');

const expressLayouts = require('express-ejs-layouts');

const bodyParser = require('body-parser')
const cors = require('cors');
const { readFileSync } = require('fs');

const app = express();

const PORT = ENV.PORT || 3000;

app.use(bodyParser.json({ limit: '100mb', extended: true })) //je met 100Mb pour prendre en charge les fichiers excel plus large
app.use(bodyParser.urlencoded({ limit: '100mb', extended: true })) //je met 100Mb pour prendre en charge les fichiers excel plus large
//app.use(bodyParser.urlencoded({ limit: '100mb', extended: true }));
//app.use(bodyParser.json());



app.use(cors())
app.use(cookieParser());

const { isAuthenticated } = require('./app/middlewares/authMiddleware');




// --- Configuration i18n (Internationalisation) ---
i18n.configure({
    locales: ['fr', 'en'], // Langues supportÃ©es
    defaultLocale: 'fr',   // Langue par dÃ©faut
    cookie: 'lang',        // Nom du cookie pour stocker la langue
    directory: path.join(__dirname, 'app', 'locales'), // Chemin vers le dossier des fichiers de traduction
    objectNotation: true, // Permet d'utiliser des objets imbriquÃ©s pour les traductions
    syncFiles: true,      // CrÃ©e les fichiers de traduction si non existants
    updateFiles: true,    // Met Ã  jour les fichiers de traduction avec les clÃ©s manquantes
    //autoReload: process.env.NODE_ENV !== 'production', // Recharger les fichiers de traduction en dev
    /*
    logWarnFn: function (msg) { // <-- AJOUTEZ CETTE LIGNE OU SIMPLEMENT 'logWarnFn: console.warn'
        console.warn('i18n warning:', msg);
    }
    */
    register: "req", // Attacher __ Ã  l'objet req (souvent prÃ©fÃ©rable pour un accÃ¨s contextuel)
    syncFiles: true, // CrÃ©e les fichiers de locale manquants
    register: global // Rend les fonctions comme __(), __n(), getLocale disponibles globalement
    // Ou sur req/res si vous ne voulez pas de global (optionnel, selon la bibliothÃ¨que)
});






/*
app.use(logger('dev'));


app.use(express.json());
app.use(bodyParser.json()); // support json encoded bodies
app.use(express.urlencoded({ extended: true }));
app.use(methodOverride('_method'));

app.use(cors())
app.use(cookieParser());
*/




app.use(session({
    secret: process.env.SESSION_SECRET || 'your_super_secret_session_key',
    resave: false,
    saveUninitialized: true,
    cookie: {
        secure: false /*process.env.NODE_ENV === 'production'*/,
        httpOnly: true,
        maxAge: 24 * 60 * 60 * 10000
    }
}));
app.use(flash());
app.use(i18n.init); // Initialise i18n comme middleware


// NOUVEAU MIDDLEWARE : EmpÃªche les messages flash en double et gÃ¨re le nettoyage
app.use((req, res, next) => {
    // Sauvegarde une rÃ©fÃ©rence Ã  la fonction flash originale
    const originalFlash = req.flash;


    // Surcharge la fonction req.flash
    req.flash = function (type, msg) {
        // 1. Si 'msg' est undefined, c'est un appel pour rÃ©cupÃ©rer les messages (getter).
        // On passe Ã  la fonction originale qui gÃ¨re cela et vide les messages.
        if (msg === undefined) {
            return originalFlash.call(this, type);
        }

        // 2. Si 'msg' est null ou un tableau vide, c'est une instruction pour VIDER les messages.
        // La faÃ§on la plus sÃ»re de vider est d'appeler la fonction originale en mode getter,
        // ce qui supprime les messages de la session.
        if (msg === null || (Array.isArray(msg) && msg.length === 0)) {
            originalFlash.call(this, type); // Appelle la fonction originale comme un getter pour vider
            return []; // Retourne un tableau vide pour indiquer que les messages ont Ã©tÃ© vidÃ©s
        }

        // 3. Si 'msg' est dÃ©fini et non pour vider, c'est un appel pour DÃ‰FINIR un ou plusieurs messages.
        // RÃ©cupÃ¨re les messages flash existants pour ce type (sans les vider) pour la dÃ©duplication.
        // Ajout d'une vÃ©rification robuste pour s'assurer que req.session et req.session.flash existent.
        const existingMessages = (req.session && req.session.flash && Array.isArray(req.session.flash[type]))
            ? req.session.flash[type]
            : [];
        let messagesToActuallyAdd = [];

        if (Array.isArray(msg)) {
            // Si 'msg' est un tableau de messages, filtre ceux qui sont dÃ©jÃ  prÃ©sents
            messagesToActuallyAdd = msg.filter(m => !existingMessages.includes(m));
        } else {
            // Si 'msg' est un seul message, l'ajoute seulement s'il n'est pas dÃ©jÃ  prÃ©sent
            if (!existingMessages.includes(msg)) {
                messagesToActuallyAdd.push(msg);
            }
        }

        // Appelle la fonction flash originale seulement s'il y a de nouveaux messages uniques Ã  ajouter
        if (messagesToActuallyAdd.length > 0) {
            return originalFlash.call(this, type, messagesToActuallyAdd);
        }

        // Si aucun nouveau message unique n'a Ã©tÃ© ajoutÃ©, retourne un tableau vide
        return [];
    };
    next();
});





// 3. Utilisez csurf APRÃˆS cookie-parser et express-session
// L'option { cookie: true } signifie que le jeton CSRF est stockÃ© dans un cookie.
//app.use(csurf({ cookie: true }));


// NOUVEAU MIDDLEWARE : GÃ¨re les redirections basÃ©es sur l'authentification et l'URL.
// Ce middleware doit Ãªtre placÃ© APRES l'initialisation de 'session' et 'flash',
// mais AVANT la dÃ©finition de vos routes principales (app.use('/dashboard', ...), etc.)

app.use(isAuthenticated, (req, res, next) => {
    // Assumons que req.authUser est dÃ©fini par un middleware d'authentification prÃ©cÃ©dent
    // (par ex., aprÃ¨s dÃ©codage d'un JWT ou chargement de l'utilisateur basÃ© sur la session).
    // Si votre application utilise une autre propriÃ©tÃ© (ex: req.user, req.session.userId),
    // ajustez la condition `!req.authUser` en consÃ©quence.
    const rolesData = JSON.parse(readFileSync('./app/storage/roles.json'));

    res.rolesData = rolesData;
    req.rolesData = rolesData;
    const isRoot = req.originalUrl.startsWith('/') && req.originalUrl.endsWith('/') && req.originalUrl == "/";
    const isAuthRoute = req.originalUrl.startsWith('/auth') || req.originalUrl.startsWith('/login');
    const isPublicFormRoute = req.originalUrl.startsWith('/public');
    const isApiRoute = req.originalUrl.startsWith('/api');
    // Une vÃ©rification simple pour les assets statiques. express.static gÃ¨re gÃ©nÃ©ralement cela avant.
    // Cette vÃ©rification est une sÃ©curitÃ© si des requÃªtes directes aux assets passent par ici.
    const isStaticAsset = req.originalUrl.includes('.') && (req.originalUrl.startsWith('/assets/') || req.originalUrl.startsWith('/css/') || req.originalUrl.startsWith('/js/') || req.originalUrl.startsWith('/img/'));
    //console.log(req.originalUrl,isStaticAsset)


    // Les requÃªtes API et les assets statiques ne sont pas affectÃ©s par cette logique de redirection web.
    if (isRoot) {
        return res.redirect(req.session.returnTo || '/dashboard');
    }

    // Les requÃªtes API et les assets statiques ne sont pas affectÃ©s par cette logique de redirection web.
    if (isApiRoute || isStaticAsset) {
        return next();
    }


    if (!req.authUser) { // L'utilisateur N'EST PAS authentifiÃ©
        if (req.originalUrl === '/') {
            // Si l'utilisateur non authentifiÃ© arrive Ã  la racine, redirigez-le vers la page de connexion.
            return res.redirect('/auth/login');
        } else if (!isAuthRoute) {
            // Si l'utilisateur non authentifiÃ© tente d'accÃ©der Ã  une page protÃ©gÃ©e
            // (qui n'est ni /auth, ni /public, ni la racine),


            // sauvegardez l'URL et redirigez vers la connexion.
            req.session.returnTo = req.originalUrl;


            req.flash('errorMessage', null);
            req.flash('errorMessage', ('Veuillez vous connecter pour accÃ©der Ã  cette page.'));
            return res.redirect('/auth/login');
        }
    } else { // L'utilisateur EST authentifiÃ©
        if (req.originalUrl === '/' || req.originalUrl === '/auth/login') {
            // Si l'utilisateur authentifiÃ© arrive Ã  la racine ou Ã  la page de connexion,
            // redirigez-le directement vers le tableau de bord.
            // Effacez toute URL de retour persistante si l'utilisateur est dÃ©jÃ  connectÃ©.
            delete req.session.returnTo;
            return res.redirect('/dashboard');
        }
    }


    res.locals.messages = req.flash('messages');
    res.locals.successMessage = req.flash('successMessage');
    res.locals.successMessages = req.flash('success');
    res.locals.errorMessage = req.flash('errorMessage');
    res.locals.formErrors = req.flash('formErrors'); // Pour les erreurs de validation
    res.locals.formData = req.flash('formData')[0]; // Pour repopuler le formulaire, flash retourne un tableau

    // Ceci rend le jeton accessible dans EJS via locals.csrfToken
    //res.locals.csrfToken = req.csrfToken();

    // S'assurer que ces variables sont disponibles dans toutes les vues
    res.locals.user = req.authUser; // Contient l'objet utilisateur dÃ©codÃ© du JWT (ex: { id: ..., entityId: ... })
    res.locals.userRoles = req.userRoles; // Contient le tableau des rÃ´les (ex: ['super_admin'])
    res.locals.hasPermission = req.hasPermission
    res.locals.T = i18n
    res.locals.req = req; // Pour accÃ©der Ã  req.flash
    // Exemple de req.user (Ã  remplacer par votre logique d'authentification rÃ©elle)
    // req.user = { id: 1, role: 'super_admin' };


    res.locals.title = i18n.__('FinTRAX');
    res.locals.pageTitle = i18n.__('FinTRAX');
    res.locals.pageDescription = i18n.__('FinTRAX Projet');

    res.locals.googleMapsApiKey = ENV.GOOGLE_MAPS_API_KEY;

    next(); // Passe au middleware suivant ou Ã  la route si aucune redirection n'a eu lieu
});



// Ajoutez ceci APRÃˆS csurf


// GÃ©rer les erreurs CSRF spÃ©cifiquement (DOIT Ãªtre aprÃ¨s csurf, mais avant vos routes spÃ©cifiques si vous avez des routes sans CSRF)
app.use((err, req, res, next) => {
    if (err.code === 'EBADCSRFTOKEN') {
        console.error('Erreur CSRF Token:', err.message);
        if (req.xhr || req.headers.accept.includes('application/json')) {
            return res.status(403).json({ success: false, message: ('Jeton CSRF invalide. Veuillez rÃ©essayer.') });
        }
        req.flash('errorMessage', ('Jeton de sÃ©curitÃ© invalide. Veuillez rÃ©essayer.'));
        return res.redirect('back');
    }
    // GÃ©rer les erreurs de Multer (taille de fichier, type de fichier)
    if (err instanceof multer.MulterError) {
        console.error('Multer Error:', err.message);
        if (req.xhr || req.headers.accept